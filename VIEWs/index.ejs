<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="STYLES/quiz.css"/> <!--make a note about this-->
    <title>Quiz</title>
</head>
<body>
    <form action="/submit" method="post">
        <div id = "card-container">
            <div id = "card">
                <div id = "game-info">
                    <div id = "round">
                        <p>Round <%=round%></p>
                        <p>question <%=questionIndex + 1 %></p>
                    </div>
                    <div>
                        <p id="timer"><%=count%></p>
                    </div>
                </div>
                <div id = "questions">
                    <p><%=questionsAndCategory[questionIndex].question%></p>
                    <% console.log(questionsAndCategory[questionIndex].category) %>
                        <ol id="options">
                        </ol>
   
                </div>
            
                <div id = "controls">
                    <div id = "prev-container">
                        <button type="submit" name="control" value="PREV" <%= disablePrev ? "disabled" : "" %>>PREV</button>
                    </div>
                    <div id = "start-time">
                        <button type="button" value="START TIME" id = "start-time-btn">START TIME</button>
                    </div>
                    <div id = "next-container">
                        <button type="submit" name="control" value="NEXT" id = "next">NEXT</button>
                    </div>
                </div>
            </div>
        </div>
    </form>


    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        let questionCategory = '<%=questionsAndCategory[questionIndex].category%>';
        console.log('Question Category:', questionCategory);
        let count = 0;
        let counter = null;

        function startTimer(initial) {
            // choose initial value: explicit arg wins, otherwise category-based default
            //initial input allows any number to be put in, think of as place holder
            const startValue = (typeof initial === 'number')
                ? initial
                : (questionCategory === 'riddle' ? 120 : 30);

            // clear any existing timer
            if (counter) {
                clearInterval(counter);
                counter = null;
            }

            // set and show the starting value
            count = startValue;
            const el = document.getElementById('timer');
            if (el) el.textContent = String(count);

            // countdown
            counter = setInterval(() => {
                count--;
                if (el) el.textContent = (count > 0) ? String(count) : "Time's up!";
                if (count <= 0) {
                    clearInterval(counter);
                    counter = null;
                }
            }, 1000);
        }

        function stopTimer() {
            if (counter) {
                clearInterval(counter);
                counter = null;
            }
        }

        // Start the timer when the page finishes loading
        document.addEventListener('DOMContentLoaded', () => {
            startTimer(); // uses category default
        });

        $('#start-time-btn').click(function() {
            startTimer(); // or startTimer(120) to force riddle
            console.log('Timer started');
        });

        document.addEventListener('DOMContentLoaded', () => {
        // safe injection from server into client
        const q = <%- JSON.stringify((questionsAndCategory && questionsAndCategory[questionIndex]) || {}) %>;
        const roundNum = <%= Number(round) %>;
        const qIndex = <%= Number(questionIndex) %>;
        console.log("q.category is" , q.category);
        if ( q.category === 'MCQ') {
            const options = [q.optiona, q.optionb, q.optionc, q.answer];
            const letters = ['A', 'B', 'C', 'D'];

            // Shuffle non-destructively
            const shuffled = options.slice().sort(() => Math.random() - 0.5);

            // Find index of correct answer in shuffled array robustly
            const indexAnswer = shuffled.findIndex(opt => String(opt).trim() === String(q.answer).trim());

            const letterCode = {0: 'A', 1: 'B', 2: 'C', 3: 'D'};
            if (indexAnswer >= 0) {
                localStorage.setItem(q.answer, letterCode[indexAnswer]);
                } else {
                console.warn('Correct answer not found in shuffled options', q.answer, shuffled);
                }

            // Render plain (non-clickable) shuffled options into the <ol id="options">
            const list = document.getElementById('options');
            if (list) {
                list.innerHTML = ''; // clear previous entries
                shuffled.forEach((opt, i) => {
                    const li = document.createElement('li');
                    li.id = `opt-${i}`;
                    li.textContent = `${letters[i]}. ${opt}`;
                    list.appendChild(li);
                });
            }
        } else if( roundNum === 9) {
            localStorage.clear();
        }
});
    </script>

</body>
</html>